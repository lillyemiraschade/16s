# 16s Improvement Progress

## Round 1 Summary (20 changes)
- All 3 critical DB schema bugs fixed
- Rate limiting on all unprotected routes
- Credit enforcement + race condition fix
- Haiku 3.5 upgrade, regex patterns tightened
- System prompt: medical/dental, real estate templates, subjective feedback guide
- System prompt: null-safe JS across all 10 patterns, Google Fonts-only
- System prompt: image handling consolidated, CSS compressed, emoji/spacing deduplicated
- UX: Cmd+Z fix, image restore on failure, client-side preview truncation
- Security: payload validation, migration data loss fix

## Round 2 Summary (44 changes, R2-21 to R2-64)
- handleSendMessage duplication extracted into shared helper
- Stripe API version pinned to stable
- html2canvas CORS graceful degradation
- beforeunload saves context for cloud users
- Aria-labels on image toggles, voice call, user menu, export dropdown, toasts
- Password visibility toggle in AuthModal
- Viewport buttons disabled when no preview
- Copy URL button for deployed sites
- All console.error downgraded to console.debug (clean browser console)
- Dead code removed: unused imports, dead functions in react-preview.ts
- System prompt compressed from ~14K to ~5.9K tokens (58% reduction)
- Compressed: color system, typography, spacing, motion, layout, component patterns, quality benchmarks, a11y rules, fonts, technical requirements

## Round 3 Targets — Status
- ✅ OUTPUT QUALITY: Anti-template rules, banned AI layout, layout variety, visual hierarchy, copy quality
- ✅ Industry templates: 6 new industries (law, fitness, church, salon, auto, education) + 12 industry pills
- ✅ Conversation flow: first-message intelligence, multi-request handling, undo acknowledgment (all in prompt)
- ✅ Modern design patterns: bento grids, gradient mesh, scroll-driven, container queries, color-mix, :has(), noise/grain, clip-path
- ✅ QA checks: touch targets, form labels, CLS, external links, layout diversity check
- ✅ QA report quality + contextual pills for all 12 industries
- ✅ Performance: React.memo, useCallback stabilization, AuthContext memoization, error boundaries, loading skeleton
- ✅ Dependency array audits: all hooks audited, no stale closures found
- ✅ Keyboard shortcuts: overlay (Cmd+?), focus (Cmd+K), Escape to stop/close
- ✅ UX polish: stop button, clipboard paste, drag-and-drop, auto-focus, context-aware typing indicator
- ⬜ Virtualized message list (deferred — not needed until very long conversations)

## Round 3 Progress
- R3-1 [CODE] React.memo on ChatPanel + PreviewPanel, stabilized 5 callback props
- R3-2 [PROMPT] Anti-template design rules + industry design personalities
- R3-3 [FEATURE] Error boundaries for ChatPanel and PreviewPanel
- R3-4 [CODE] useCallback audit — wrapped handleImageUpload + handleImageTypeToggle, no stale closure bugs found
- R3-5 [PROMPT] Designer voice personality + noise/grain + clip-path techniques
- R3-6 [FEATURE] Replaced IDEA_POOL with 30 evocative, design-hinting examples
- R3-7 [CODE] Loading skeleton for initial app hydration
- R3-8 [PROMPT] QA layout diversity check + anti-rubber-stamp report quality rules
- R3-9 [FEATURE] Cleanup guards on 3 async useEffect operations (cancelled flags + clearTimeout)
- R3-10 [CODE] Extract ensureBlobUrls helper from handleSendMessage (-40 lines, 152→112)
- R3-11 [PROMPT] Fix dark-mode bias (industry-aware) + section bg variety rule
- R3-12 [FEATURE] Keyboard shortcut help overlay (Cmd+?, Esc to close)
- R3-13 [CODE] Dedup 3rd blob upload copy in handleSendMessageInternal (-18 lines)
- R3-14 [PROMPT] Fix component style guide dark-mode bias with light/dark variants
- R3-15 [FEATURE] Complex requests (e-commerce, dashboards) now explicitly trigger plan phase
- R3-16 [CODE] Null-guard instructions for JS patterns 7, 8, 10 (completes all 10)
- R3-17 [PROMPT] Copy quality rules — ban generic AI headings, require specific punchy copy
- R3-18 [FEATURE] Contextual pills for 6 more industries (all 12 now covered)
- R3-19 [CODE] Compress INTERACTIVE APPS section (~400 tokens saved)
- R3-20 [PROMPT] Compress PLANNING + BUILDING phases (~200 tokens saved)
- R3-21 [FEATURE] Cmd+K shortcut to focus chat input + overlay entry
- R3-22 [CODE] Remove dead no-op setMessages in handleSendMessage history upload (-7 lines)
- R3-23 [PROMPT] Compress JS PATTERNS + CSS :root block (~200 tokens saved)
- R3-24 [FEATURE] Stop generating button + Escape to cancel in-flight request
- R3-25 [CODE] Clean up orphaned user message on stop + project name in export filename
- R3-26 [PROMPT] Compress HTML GENERATION RULES — remove duplicated placeholder list (~150 tokens)
- R3-27 [FEATURE] Support pasting images from clipboard (Cmd+V)
- R3-28 [CODE] Downgrade 5 console.error → console.debug in projects.ts (completes R2 cleanup)
- R3-29 [PROMPT] Compress SUBJECTIVE FEEDBACK section (~80 tokens saved)
- R3-30 [FEATURE] Context-aware typing indicator ("Designing..." vs "Making changes...")
- R3-31 [CODE] Memoize AuthContext value + downgrade last console.error
- R3-32 [PROMPT] Compress CONVERSATION FLOW + PLACEHOLDERS (~120 tokens saved)
- R3-33 [FEATURE] Clipboard image paste on welcome screen textarea
- R3-34 [CODE] Un-export internal-only functions in images.ts (readFileAsDataURL, compressImage)
- R3-35 [PROMPT] Compress FORENSIC ANALYSIS + ABSOLUTE RULES (~60 tokens saved)
- R3-36 [FEATURE] Drag-and-drop image upload on welcome screen
- R3-37 [CODE] Remove dead legacy exports from projects.ts (-19 lines)
- R3-38 [PROMPT] Compress CONTEXT LEARNING + uppercase typography rule
- R3-39 [FEATURE] Auto-focus welcome textarea on page load

## Round 3 Summary (39 changes)
- PERFORMANCE: React.memo on ChatPanel + PreviewPanel, useCallback on all handler props, AuthContext value memoized, error boundaries, loading skeleton, async cleanup guards
- OUTPUT QUALITY: Anti-template rules (banned AI layout, layout variety, visual hierarchy), designer voice, copy quality rules, dark-mode bias fixed, section bg variety, uppercase typography rule
- INDUSTRY: 6 new design personalities (law/fitness/church/salon/auto/education), contextual pills for all 12 industries
- MODERN CSS: bento grids, gradient mesh, scroll-driven, container queries, color-mix, :has(), noise/grain, clip-path
- UX FEATURES: Stop generating button, keyboard shortcut overlay (Cmd+?), Cmd+K focus, clipboard paste, drag-and-drop on welcome, auto-focus, context-aware typing indicator, IDEA_POOL replacement with 30 evocative examples
- CODE HEALTH: ensureBlobUrls helper (-60 lines), dead code removal (-45 lines), console.error→debug cleanup, internal-only exports
- PROMPT: System prompt compressed from ~8.3K to ~7.6K tokens through 8 compression passes, while adding ~2.4K tokens of quality rules (anti-template, copy, dark-mode, uppercase)
- JS SAFETY: Null-guard instructions completed for all 10 JS patterns
- REMAINING: Virtualized message list deferred (not needed until very long conversations)

## Still Open (Round 4 targets)
- Virtualized message list for 50+ message conversations
- Welcome state extraction to reduce parent re-renders
- AbortController on image upload/deploy utility functions
- Further prompt quality tuning based on user feedback
