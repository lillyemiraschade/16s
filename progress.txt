# 16s Improvement Progress

## History
- Rounds 1-4: 113 code/prompt changes, prompt compressed 14K→5.9K tokens
- Round 5 (Flow): Conversation flow, inspo-first, photo intelligence
- Ultimate R1: 10 findings fixed (postMessage validation, Stripe rate limiting, auto-scroll yank, pill states, unhandled promises, decodeURI crash, error timer cleanup, modern CSS prompt, error toast UX, localStorage quota handling)

## Ultimate R2 — Deep Audit

### Cycle 1: SECURITY (Endpoint-by-endpoint curl testing)
**Tests run:**
- /api/chat: no auth → processes (free tier by design), 50K msg → 400 rejected, 200 msgs → 400 rejected, role=system → 400 rejected (Zod enum), text/plain Content-Type → parsed anyway (Next.js behavior), 25 rapid requests → rate limit fires at request 21 ✓
- /api/upload: no auth → 401, non-string imageData → 401 (auth first), javascript: URI → 401 (auth first)
- /api/remove-bg: no auth → 401
- /api/deploy: no auth → 401 (CRITICAL: verified)
- /api/stripe/checkout: no auth → 401, invalid plan → 401 (auth first), missing plan → 401 (auth first)
- /api/stripe/webhook: no signature → 400, fake signature → 500 (webhook secret not configured locally)
- CORS: evil.com origin → 403 ✓, allowed origin → proper ACAO header ✓
- Security headers: All present (CSP, COOP, CORP, X-Frame-Options, X-Content-Type-Options, Referrer-Policy, Permissions-Policy)

**Findings fixed:**
- [x] S1: Deploy route had NO size limit on HTML payload — added 5MB cap
- [x] S2: Deploy route leaked Vercel API error details to client — removed `details` field
- [x] S3: Missing Cross-Origin-Embedder-Policy header — added `unsafe-none`

### Cycle 2: APP UI (Edge case analysis)
**Findings fixed:**
- [x] U1: previewHistory grew unbounded (100+ versions × 200KB = 20MB+ memory) — capped at 50

**Verified OK:**
- Double-send protection: isGenerating check + disabled button + AbortController ✓
- File type validation: processImageFiles checks file.type.startsWith("image/") + max 5 files + 10MB limit ✓
- Empty HTML: srcDoc={previewHtml || ""} shows blank ✓
- Iframe sandbox: allow-scripts allow-same-origin ✓

### Cycle 3: OUTPUT QUALITY (Prompt analysis)
**Findings fixed:**
- [x] O1: No footer design rules — added multi-column footer spec to COMPONENT PATTERNS
- [x] O2: Pill suggestions didn't check existing features — added "check what's already built" rule
- [x] O3: Inspo-skip directions not industry-contextual — now requires relevant style options
- [x] O4: QA checklist missing heading hierarchy — added h1→h2→h3 + fallback fonts checks
- [x] O5: Redundant MODERN CSS line in LAYOUT PATTERNS — removed (duplicated earlier section)
- [x] O6: PRE-OUTPUT CHECK repeated QA items — compressed, added heading/footer checks

### Cycle 4: CODE (Deep dive)
**Findings fixed:**
- [x] C1: AuthModal OAuth 3s timeout had no cleanup — could setState on unmounted component. Added ref + clearTimeout

**Verified OK:**
- All API routes return proper 4xx/5xx status codes (no 200 on error) ✓
- All setInterval/setTimeout have cleanup (except the AuthModal fix above) ✓
- All window.addEventListener have removeEventListener cleanup ✓
- AbortController properly managed ✓
- Type casts minimal: 2 `as unknown` (both documented, intentional) ✓

### Cycle 5: PROMPT (Voice prompt + compression)
**Verified OK:**
- Voice prompt aligns with main flow (DISCOVER → inspo handoff) ✓
- Voice prompt has state tracking for longer calls ✓
- Voice prompt has proper inspo handoff language ✓

### Cycle 6: DEEP CODE AUDIT (Race conditions, memory leaks, edge cases)
**Deep audit of all major files for race conditions, state staleness, and cleanup gaps.**

**Findings fixed:**
- [x] C2: VoiceCall silenceTimer was a local variable — not cleared on unmount/endCall. Could fire setState after unmount. Moved to ref + cleanup.
- [x] C3: handleImageTypeToggle used index-based lookup for async updates — race condition if images added/removed between compress/upload. Switched to data-based identity matching.

**Verified OK (noted but not fixed — requires schema changes or cross-cutting concerns):**
- Stripe webhook duplicate delivery: Updates are largely idempotent (`.update()` with same data). current_period_end uses Date.now() so duplicates shift date slightly. Fix requires webhook_events table (schema change). NOTED.
- html_snapshot stored in deployments table: Up to 5MB per deploy. Fills DB over time. Fix requires schema refactor. NOTED.
- Promise.allSettled for history image uploads: Fire-and-forget pattern is intentional — these are historical images, not needed for the current API call. URLs from current message are already resolved via ensureBlobUrls(). VERIFIED OK.
- Rate-limit Map never fully cleaned in deploy route: Only sweeps when >500 entries. In serverless (Vercel), map resets on cold start, so this is a non-issue in production. VERIFIED OK.
- Migration race across tabs: useProjects hook has migrationStatus guard per-component. Cross-tab races possible but Supabase upsert (onConflict: "id") makes duplicates harmless. VERIFIED OK.
- navGuard injection: Regex-based but only injects after first `<head>` tag. AI-generated HTML is sandboxed in iframe with allow-scripts allow-same-origin. XSS in iframe cannot escape to parent. VERIFIED OK.
- Code edit debounce race: Only occurs if user edits in Monaco while AI generates simultaneously. useEffect guard `!lastCodeRef.current` prevents AI from overwriting user edits. Edge case accepted.

### npm audit
- 4 Next.js vulnerabilities (3 high, 1 critical) in v14.2.18
- Fix requires upgrading to 14.2.35 (`npm audit fix --force`)
- NOTED: Requires testing — not auto-applied to avoid breaking changes

## Summary
Ultimate R2: 6 cycles, 13 findings fixed (3 security, 1 UI, 6 output quality, 3 code).
Total across all rounds: 136 changes.
